#!/bin/bash

function magic() {
    local installed="$(magic_from "$PWD" | tac)"

    for magic in $installed; do
	echo "$magic/.spells"
    done
}

function magic_from() {
    local dir="$1"
    [[ -z "$dir" ]] && return

    while [[ "$dir" != "/" ]]; do
	[[ -r "$dir/.spells" ]] && [[ -O "$dir/.spells" ]] && echo "$dir "
	dir="$(dirname "$dir")"
    done
}

function magic_install() {
    local magic="$1"
    
    if [[ -w "$magic" ]] && [[ -O "$magic/.spells" ]]; then
	source "$magic/.spells" > /dev/null
    fi
}

function magic_uninstall() {
    local magic="$1"    
    unset $(bash $magic/.spells)
}

if [[ "$PWD" != "$MAGIC_LAST" ]]; then
    
    uninstall="$(magic_from "$MAGIC_LAST")"
    install="$(magic_from "$PWD" | tac)"

    if [[ "$uninstall" != "$install" ]]; then

	for magic in $uninstall; do
	    magic_uninstall "$magic"
	done

	for magic in $install; do
	    magic_install "$magic"
	done
    fi;

    unset install uninstall
    MAGIC_LAST="$PWD"
fi;
